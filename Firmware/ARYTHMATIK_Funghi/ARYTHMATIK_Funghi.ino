#include "src/libmodulove/arythmatik.h"
#include <avr/pgmspace.h>

using namespace modulove;
using namespace arythmatik;

// Declare A-RYTH-MATIK hardware variable.
Arythmatik hw;

// Simulation parameters
uint8_t attraction = 7;
uint8_t repulsion = 3;
uint8_t randomness = 6;

// UI elements
uint8_t selectedParameter = 0;
const char parameterNames[][12] PROGMEM = { "Attraction", "Repulsion", "Randomness" };

// Slime Mold simulation state using a reduced grid size
constexpr uint8_t gridWidth = SCREEN_WIDTH / 3;  // 42 columns (3x3 cells)
constexpr uint8_t gridHeight = 7;                // 7 rows (14 pixels)
uint8_t grid[gridWidth][gridHeight] = {};    // Use bytes to represent cell states (1 byte per row)
uint8_t tempGrid[gridWidth][gridHeight] = {};  // Temporary SRAM buffer for fast access

const uint8_t initialGridBits[] PROGMEM = {
    0b01001001, 0b10110011, 0b01001110, 0b10100111, 
    0b01001110, 0b10100001, 0b01010110
};

// Add a reset counter
uint8_t resetCounter = 0;
const uint8_t resetThreshold = 4;  // Number of resets before randomization starts




uint8_t stuckCounter = 0;         // Counter to detect if the simulation is stuck
uint8_t centricSpawnCounter = 0;  // Counter to trigger centric random cell birth

// EEPROM settings
unsigned long lastEEPROMWrite = 0;
const unsigned long EEPROM_WRITE_INTERVAL = 300000; // 5 minutes

// Clock control
bool useExternalClock = false;  // Flag for external clock usage
unsigned long lastClockTime = 0;
unsigned long clockInterval = 600;  // Initial interval for ~100 BPM
uint8_t clockOutput = 0;
uint8_t maxCells = 75;  // Maximum number of live cells allowed to maintain smooth operation

const uint8_t MIN_CELLS = 45;      // Minimum number of cells before gradual spawning starts
const uint8_t SPAWN_INTERVAL = 2;  // Number of updates between spawn attempts

const unsigned long CLOCK_TIMEOUT = 1000;  // 1 second timeout for external clock
unsigned long lastExternalClockTime = 0;
const unsigned long INTERNAL_CLOCK_INTERVAL = 200;

bool isInitialState = true;         // Added declaration
const uint8_t RESET_THRESHOLD = 1;  // Number of resets before returning to initial state


// Neighbor lookup table stored in PROGMEM to speed up neighbor checks
const uint8_t neighborOffsets[8][2] PROGMEM = {
  { 255, 255 }, { 255, 0 }, { 255, 1 }, { 0, 255 }, { 0, 1 }, { 1, 255 }, { 1, 0 }, { 1, 1 }
};

// OLED Animation 3 dancing Mushrooms (only first frame here, there are 16 of them in total)
// 'Omri_Pilztag00', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag00[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x03, 0xf0, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f,
  0xe0, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00,
  0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x0c, 0x30, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x1c, 0x18, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x3e, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x1c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x1f, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc0,
  0x01, 0xc0, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x60, 0x03, 0x00,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x60, 0x03, 0x00, 0x01, 0xc1,
  0xc6, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x30, 0x10, 0x70, 0x02, 0x00, 0x00, 0xe1, 0x84, 0x00,
  0x07, 0x03, 0xc0, 0x00, 0x00, 0x20, 0x38, 0x18, 0x02, 0x00, 0x00, 0x40, 0x04, 0x00, 0x1e, 0x00,
  0x60, 0x00, 0x00, 0x60, 0x70, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x38, 0x30, 0x30, 0x00,
  0x00, 0x40, 0x00, 0x84, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x70, 0x38, 0x18, 0x00, 0x00, 0xc0,
  0x01, 0xc4, 0x03, 0x00, 0x3f, 0xf8, 0x18, 0x00, 0x40, 0x00, 0x08, 0x00, 0x00, 0xc0, 0x00, 0xc6,
  0x06, 0x00, 0xff, 0xff, 0x78, 0x01, 0xc0, 0x01, 0x8c, 0x00, 0x00, 0x86, 0x18, 0x02, 0x03, 0x03,
  0xf0, 0x3f, 0xf8, 0x01, 0x08, 0xe1, 0x84, 0x00, 0x00, 0x86, 0x18, 0x02, 0x03, 0x1f, 0xe0, 0x20,
  0x38, 0x01, 0x1c, 0x40, 0x04, 0x00, 0x00, 0x86, 0x00, 0x02, 0x01, 0xfc, 0x60, 0x60, 0x60, 0x01,
  0x18, 0x00, 0x18, 0x00, 0x00, 0xc0, 0x00, 0x04, 0x00, 0xe0, 0x40, 0x61, 0xc0, 0x00, 0x80, 0x00,
  0x10, 0x00, 0x00, 0x41, 0xff, 0xc0, 0x00, 0xe0, 0x40, 0x73, 0x00, 0x00, 0xc0, 0xfc, 0x70, 0x00,
  0x00, 0x6f, 0xe1, 0x70, 0x00, 0xc0, 0x80, 0x7e, 0x00, 0x00, 0x4f, 0xdf, 0xe0, 0x00, 0x00, 0x38,
  0x41, 0x10, 0x00, 0xc1, 0x80, 0x60, 0x00, 0x00, 0x78, 0x88, 0x40, 0x00, 0x00, 0x18, 0x43, 0x20,
  0x00, 0x7f, 0x80, 0x60, 0x00, 0x00, 0x30, 0x89, 0xc0, 0x00, 0x00, 0x0e, 0x43, 0xc0, 0x00, 0x07,
  0x00, 0x60, 0x00, 0x00, 0x1f, 0x8f, 0x80, 0x00, 0x00, 0x07, 0xc3, 0x00, 0x00, 0x07, 0x00, 0x60,
  0x00, 0x00, 0x07, 0x90, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x07, 0x00, 0x60, 0x00, 0x00,
  0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x06, 0x00, 0xe0, 0x00, 0x00, 0x01, 0x10,
  0x00, 0x00, 0x00, 0x01, 0x81, 0x00, 0x00, 0x0e, 0x00, 0xf0, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00,
  0x00, 0x01, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x38, 0x00, 0x00, 0x03, 0x08, 0x00, 0x00, 0x00, 0x03,
  0x01, 0x00, 0x00, 0x38, 0x00, 0x7c, 0x00, 0x00, 0x06, 0x0c, 0x00, 0x00, 0x00, 0x07, 0x03, 0x00,
  0x00, 0x38, 0x00, 0x7c, 0x00, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00, 0x0e, 0x03, 0x80, 0x00, 0x70,
  0x00, 0x1e, 0x1f, 0xff, 0xff, 0xc8, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xe0, 0x00, 0x1f,
  0xff, 0xff, 0xff, 0xfe, 0x03, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x0f, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag01', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag01[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x03, 0xf0, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xe0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f,
  0xe0, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00,
  0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x18, 0x30, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x1c, 0x18, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x3e, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x1c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x1f, 0x00, 0x01, 0x80, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc0,
  0x03, 0x80, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x60, 0x03, 0x00,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x60, 0x03, 0x00, 0x01, 0xc1,
  0xc6, 0x00, 0x01, 0xf3, 0xc0, 0x00, 0x00, 0x18, 0x08, 0x70, 0x02, 0x00, 0x00, 0xe1, 0x84, 0x00,
  0x07, 0x00, 0x60, 0x00, 0x00, 0x10, 0x1c, 0x18, 0x02, 0x00, 0x00, 0x40, 0x04, 0x00, 0x1e, 0x00,
  0x60, 0x00, 0x00, 0x30, 0x38, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x38, 0x30, 0x30, 0x00,
  0x00, 0x20, 0x00, 0x84, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x70, 0x38, 0x18, 0x00, 0x00, 0x60,
  0x01, 0xc4, 0x03, 0x00, 0x3f, 0xf0, 0x18, 0x00, 0x40, 0x00, 0x08, 0x00, 0x00, 0x60, 0x00, 0xc6,
  0x02, 0x00, 0xff, 0xfe, 0x78, 0x01, 0xc0, 0x01, 0x8c, 0x00, 0x00, 0x43, 0x18, 0x02, 0x03, 0x03,
  0xf0, 0x3f, 0xf8, 0x01, 0x08, 0xe1, 0x84, 0x00, 0x00, 0x43, 0x18, 0x02, 0x03, 0x1f, 0xe0, 0x20,
  0x78, 0x01, 0x0c, 0x40, 0x04, 0x00, 0x00, 0x43, 0x00, 0x02, 0x01, 0xfc, 0x60, 0x60, 0xc0, 0x01,
  0x18, 0x00, 0x0c, 0x00, 0x00, 0x60, 0x00, 0x06, 0x00, 0xe0, 0x40, 0x61, 0x80, 0x00, 0x80, 0x00,
  0x10, 0x00, 0x00, 0x20, 0xff, 0xc4, 0x00, 0xe0, 0x40, 0x73, 0x00, 0x00, 0xc0, 0xfc, 0x70, 0x00,
  0x00, 0x37, 0xe1, 0x78, 0x00, 0x60, 0x80, 0x7e, 0x00, 0x00, 0x4f, 0xdf, 0xe0, 0x00, 0x00, 0x1c,
  0x41, 0x18, 0x00, 0x41, 0x80, 0x60, 0x00, 0x00, 0x78, 0x88, 0x40, 0x00, 0x00, 0x08, 0x43, 0x30,
  0x00, 0x7f, 0x80, 0x60, 0x00, 0x00, 0x30, 0x89, 0xc0, 0x00, 0x00, 0x0e, 0x43, 0xe0, 0x00, 0x07,
  0x00, 0xe0, 0x00, 0x00, 0x1f, 0x8f, 0x80, 0x00, 0x00, 0x07, 0xc3, 0x00, 0x00, 0x07, 0x00, 0xe0,
  0x00, 0x00, 0x07, 0x90, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x07, 0x00, 0xe0, 0x00, 0x00,
  0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x06, 0x00, 0xc0, 0x00, 0x00, 0x01, 0x10,
  0x00, 0x00, 0x00, 0x01, 0x81, 0x00, 0x00, 0x0e, 0x00, 0xc0, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00,
  0x00, 0x01, 0x01, 0x00, 0x00, 0x1c, 0x00, 0x40, 0x00, 0x00, 0x03, 0x08, 0x00, 0x00, 0x00, 0x03,
  0x01, 0x00, 0x00, 0x38, 0x00, 0x70, 0x00, 0x00, 0x06, 0x0c, 0x00, 0x00, 0x00, 0x07, 0x01, 0x00,
  0x00, 0x38, 0x00, 0x7c, 0x00, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00, 0x0e, 0x01, 0x80, 0x00, 0x70,
  0x00, 0x3e, 0x1f, 0xff, 0xff, 0x18, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xe0, 0x00, 0x3f,
  0xff, 0xff, 0xff, 0xfe, 0x00, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x3f, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag02', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag02[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x03, 0xf0, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xe0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f,
  0xe0, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00,
  0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x30, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x1c, 0x18, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x3e, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x1c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x1f, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc0,
  0x03, 0x80, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x60, 0x03, 0x00,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x60, 0x03, 0x00, 0x01, 0xc1,
  0xc6, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x18, 0x10, 0x70, 0x02, 0x00, 0x00, 0xe1, 0x84, 0x00,
  0x07, 0x03, 0xc0, 0x00, 0x00, 0x10, 0x38, 0x18, 0x02, 0x00, 0x00, 0x40, 0x04, 0x00, 0x1e, 0x00,
  0x60, 0x00, 0x00, 0x30, 0x70, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x38, 0x30, 0x30, 0x00,
  0x00, 0x40, 0x00, 0x84, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x70, 0x38, 0x18, 0x00, 0x00, 0xc0,
  0x01, 0xc4, 0x03, 0x00, 0x3f, 0xf8, 0x18, 0x00, 0x40, 0x00, 0x08, 0x00, 0x00, 0xc0, 0x00, 0xc6,
  0x06, 0x00, 0xff, 0xff, 0x78, 0x01, 0xc0, 0x01, 0x8c, 0x00, 0x00, 0x86, 0x18, 0x02, 0x03, 0x03,
  0xf0, 0x3f, 0xf8, 0x01, 0x08, 0xe1, 0x84, 0x00, 0x00, 0x86, 0x18, 0x02, 0x03, 0x1f, 0xe0, 0x20,
  0x78, 0x01, 0x0c, 0x40, 0x04, 0x00, 0x00, 0x86, 0x00, 0x02, 0x01, 0xfc, 0x60, 0x60, 0xe0, 0x01,
  0x18, 0x00, 0x18, 0x00, 0x00, 0xc0, 0x00, 0x04, 0x00, 0xe0, 0x40, 0x61, 0xc0, 0x00, 0x80, 0x00,
  0x10, 0x00, 0x00, 0x41, 0xff, 0xc0, 0x00, 0xe0, 0x40, 0x73, 0x00, 0x00, 0xc0, 0xfc, 0x70, 0x00,
  0x00, 0x6f, 0xe1, 0x70, 0x00, 0xe0, 0x80, 0x7e, 0x00, 0x00, 0x4f, 0xdf, 0xe0, 0x00, 0x00, 0x38,
  0x41, 0x10, 0x00, 0xc1, 0x80, 0x60, 0x00, 0x00, 0x78, 0x88, 0x40, 0x00, 0x00, 0x18, 0x43, 0x20,
  0x00, 0x7f, 0x80, 0x60, 0x00, 0x00, 0x30, 0x89, 0xc0, 0x00, 0x00, 0x0e, 0x43, 0xc0, 0x00, 0x07,
  0x00, 0x60, 0x00, 0x00, 0x1f, 0x8f, 0x80, 0x00, 0x00, 0x07, 0xc3, 0x00, 0x00, 0x07, 0x00, 0x60,
  0x00, 0x00, 0x07, 0x90, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x07, 0x00, 0xe0, 0x00, 0x00,
  0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x06, 0x00, 0xe0, 0x00, 0x00, 0x01, 0x10,
  0x00, 0x00, 0x00, 0x01, 0x81, 0x00, 0x00, 0x0e, 0x00, 0xf0, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00,
  0x00, 0x01, 0x01, 0x00, 0x00, 0x1c, 0x00, 0x78, 0x00, 0x00, 0x03, 0x08, 0x00, 0x00, 0x00, 0x03,
  0x01, 0x00, 0x00, 0x38, 0x00, 0x7c, 0x00, 0x00, 0x06, 0x0c, 0x00, 0x00, 0x00, 0x07, 0x03, 0x00,
  0x00, 0x38, 0x00, 0x7c, 0x00, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00, 0x0e, 0x03, 0x80, 0x00, 0x70,
  0x00, 0x1e, 0x1f, 0xff, 0xff, 0x88, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xe0, 0x00, 0x1f,
  0xff, 0xff, 0xff, 0xfe, 0x01, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x0f, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag03', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag03[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x07, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xe0, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f,
  0xe0, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x00,
  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x0c, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x0e, 0x18, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x1e, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x3e, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x80,
  0x01, 0xc0, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0xc0, 0x01, 0x80,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x60, 0x03, 0x00, 0x01, 0xc1,
  0xc6, 0x00, 0x03, 0xff, 0x00, 0x00, 0x00, 0x60, 0x10, 0x70, 0x02, 0x00, 0x00, 0xe1, 0x84, 0x00,
  0x0f, 0x03, 0xc0, 0x00, 0x00, 0x40, 0x38, 0x18, 0x02, 0x00, 0x00, 0x40, 0x04, 0x00, 0x3e, 0x00,
  0x60, 0x00, 0x00, 0xc0, 0x70, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x78, 0x30, 0x30, 0x00,
  0x00, 0x80, 0x00, 0x84, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0xe0, 0x38, 0x18, 0x00, 0x01, 0x80,
  0x01, 0xc4, 0x03, 0x00, 0x1f, 0xf8, 0x18, 0x00, 0x80, 0x00, 0x08, 0x00, 0x01, 0x80, 0x00, 0xc6,
  0x06, 0x00, 0xff, 0xff, 0x78, 0x01, 0x80, 0x03, 0x18, 0x00, 0x01, 0x0c, 0x18, 0x00, 0x03, 0x03,
  0xf0, 0x1f, 0xf8, 0x01, 0x11, 0xc3, 0x08, 0x00, 0x01, 0x0c, 0x18, 0x04, 0x03, 0x1f, 0xe0, 0x10,
  0x38, 0x01, 0x18, 0x80, 0x08, 0x00, 0x01, 0x0c, 0x00, 0x04, 0x01, 0xfc, 0x60, 0x70, 0x60, 0x01,
  0x18, 0x00, 0x18, 0x00, 0x01, 0x80, 0x00, 0x0c, 0x00, 0xe0, 0x40, 0x70, 0xc0, 0x00, 0x80, 0x00,
  0x10, 0x00, 0x00, 0x83, 0xff, 0x88, 0x00, 0xe0, 0x40, 0x71, 0x80, 0x00, 0xc0, 0xfc, 0x70, 0x00,
  0x00, 0xdf, 0xc2, 0xf0, 0x01, 0xc0, 0x40, 0x7f, 0x00, 0x00, 0x4f, 0xdf, 0xe0, 0x00, 0x00, 0x70,
  0x82, 0x30, 0x00, 0xc1, 0x80, 0x60, 0x00, 0x00, 0x78, 0x88, 0x40, 0x00, 0x00, 0x30, 0x86, 0x60,
  0x00, 0x7f, 0x80, 0x60, 0x00, 0x00, 0x30, 0x89, 0xc0, 0x00, 0x00, 0x1c, 0x87, 0xc0, 0x00, 0x07,
  0x00, 0x60, 0x00, 0x00, 0x1f, 0x8f, 0x80, 0x00, 0x00, 0x0f, 0x86, 0x00, 0x00, 0x07, 0x00, 0x60,
  0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x00, 0x07, 0x00, 0x60, 0x00, 0x00,
  0x00, 0x90, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x00, 0x06, 0x00, 0x60, 0x00, 0x00, 0x01, 0x10,
  0x00, 0x00, 0x00, 0x03, 0x02, 0x00, 0x00, 0x0e, 0x00, 0x30, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00,
  0x00, 0x02, 0x02, 0x00, 0x00, 0x1c, 0x00, 0x38, 0x00, 0x00, 0x03, 0x08, 0x00, 0x00, 0x00, 0x06,
  0x03, 0x00, 0x00, 0x38, 0x00, 0x1c, 0x00, 0x00, 0x06, 0x0c, 0x00, 0x00, 0x00, 0x06, 0x03, 0x00,
  0x00, 0x38, 0x00, 0x1c, 0x00, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00, 0x0e, 0x03, 0x80, 0x00, 0x70,
  0x00, 0x1f, 0x0f, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xe0, 0x00, 0x1f,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag04', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag04[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x07, 0xf0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xf0, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f,
  0xe0, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00,
  0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x0c, 0x18, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x1e, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x0e, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7e, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x80,
  0x01, 0xc0, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0xc0, 0x01, 0x80,
  0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x60, 0x01, 0x80, 0x00, 0xe1,
  0xe3, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x70, 0x20, 0x70, 0x02, 0x00, 0x00, 0x70, 0xc3, 0x00,
  0x0e, 0x07, 0x80, 0x00, 0x00, 0xc0, 0x70, 0x18, 0x02, 0x00, 0x00, 0x20, 0x02, 0x00, 0x3c, 0x00,
  0xc0, 0x00, 0x00, 0x80, 0x60, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x06, 0x00, 0x70, 0x60, 0x60, 0x00,
  0x01, 0x81, 0xc1, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x06, 0x00, 0xe0, 0x70, 0x30, 0x00, 0x01, 0x00,
  0x03, 0x88, 0x03, 0x00, 0x1f, 0xfc, 0x0c, 0x00, 0x80, 0x00, 0x10, 0x00, 0x03, 0x00, 0x01, 0x8c,
  0x07, 0x00, 0x7f, 0xff, 0xbc, 0x01, 0x80, 0x03, 0x18, 0x00, 0x03, 0x00, 0x30, 0x04, 0x03, 0x01,
  0xf8, 0x1f, 0xfc, 0x00, 0x11, 0xc3, 0x08, 0x00, 0x02, 0x18, 0x30, 0x04, 0x03, 0x1f, 0xf0, 0x1c,
  0x1c, 0x00, 0x98, 0x80, 0x08, 0x00, 0x02, 0x18, 0x00, 0x04, 0x01, 0xfc, 0x30, 0x3c, 0x38, 0x00,
  0x98, 0x00, 0x18, 0x00, 0x02, 0x18, 0x00, 0x0c, 0x00, 0xe0, 0x20, 0x3c, 0x60, 0x00, 0x40, 0x00,
  0x10, 0x00, 0x03, 0x00, 0xff, 0x88, 0x00, 0xe0, 0x60, 0x3c, 0xc0, 0x00, 0x40, 0xfc, 0x70, 0x00,
  0x01, 0x03, 0xc2, 0xf0, 0x00, 0x60, 0xc0, 0x3f, 0x80, 0x00, 0x0f, 0xdf, 0xe0, 0x00, 0x01, 0x98,
  0x82, 0x30, 0x00, 0x3f, 0xc0, 0x3c, 0x00, 0x00, 0x38, 0x88, 0x40, 0x00, 0x00, 0x70, 0x86, 0x60,
  0x00, 0x03, 0x80, 0x3c, 0x00, 0x00, 0x10, 0x89, 0xc0, 0x00, 0x00, 0x1c, 0x87, 0xc0, 0x00, 0x03,
  0x80, 0x3c, 0x00, 0x00, 0x1f, 0x8f, 0x80, 0x00, 0x00, 0x0f, 0x86, 0x00, 0x00, 0x03, 0x80, 0x3c,
  0x00, 0x00, 0x07, 0x88, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x00, 0x03, 0x00, 0x3c, 0x00, 0x00,
  0x00, 0x88, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x00, 0x07, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x88,
  0x00, 0x00, 0x00, 0x03, 0x02, 0x00, 0x00, 0x06, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00,
  0x00, 0x02, 0x02, 0x00, 0x00, 0x1c, 0x00, 0x0e, 0x00, 0x00, 0x01, 0x84, 0x00, 0x00, 0x00, 0x06,
  0x03, 0x00, 0x00, 0x3c, 0x00, 0x06, 0x00, 0x00, 0x03, 0x06, 0x00, 0x00, 0x00, 0x0e, 0x03, 0x00,
  0x00, 0x3c, 0x00, 0x03, 0x07, 0xe0, 0x07, 0x06, 0x00, 0x00, 0x00, 0x0e, 0x03, 0x80, 0x00, 0x70,
  0x00, 0x03, 0x9f, 0xff, 0xff, 0xff, 0x80, 0x00, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xe3, 0x00, 0x07,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag05', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag05[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x03, 0xf0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xe0, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f,
  0xe0, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00,
  0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x0c, 0x18, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x0e, 0x0c, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x1e, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x0e, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x7c, 0x00, 0x01, 0x80, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x00,
  0x03, 0x80, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x01, 0x80, 0x03, 0x00,
  0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0xe0, 0x03, 0x00, 0x00, 0xe1,
  0xe3, 0x00, 0x03, 0xfc, 0x00, 0x00, 0x00, 0x30, 0x20, 0xf0, 0x02, 0x00, 0x00, 0x70, 0xc3, 0x00,
  0x0e, 0x0f, 0x00, 0x00, 0x00, 0x60, 0x70, 0x38, 0x02, 0x00, 0x00, 0x20, 0x02, 0x00, 0x3c, 0x01,
  0x80, 0x00, 0x00, 0x40, 0xe0, 0x1c, 0x02, 0x00, 0x00, 0x00, 0x06, 0x00, 0x70, 0xc0, 0xc0, 0x00,
  0x00, 0x80, 0x01, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x06, 0x00, 0xe0, 0xe0, 0x60, 0x00, 0x01, 0x80,
  0x03, 0x8c, 0x03, 0x00, 0x0f, 0xfc, 0x0c, 0x00, 0x80, 0x00, 0x20, 0x00, 0x01, 0x80, 0x01, 0x8e,
  0x03, 0x00, 0x7f, 0xff, 0xbc, 0x01, 0x80, 0x06, 0x30, 0x00, 0x01, 0x0c, 0x30, 0x06, 0x01, 0x81,
  0xfc, 0x0f, 0xfc, 0x01, 0x11, 0x86, 0x10, 0x00, 0x01, 0x0c, 0x30, 0x04, 0x01, 0x8f, 0xf8, 0x0c,
  0x3c, 0x01, 0x19, 0x00, 0x10, 0x00, 0x01, 0x0c, 0x00, 0x04, 0x00, 0xfe, 0x18, 0x1c, 0x30, 0x01,
  0x18, 0x00, 0x30, 0x00, 0x01, 0x80, 0x00, 0x0c, 0x00, 0x70, 0x10, 0x1e, 0x60, 0x00, 0x80, 0x00,
  0x20, 0x00, 0x00, 0x83, 0xff, 0xc8, 0x00, 0x70, 0x10, 0x0f, 0xc0, 0x00, 0xc0, 0xf8, 0xe0, 0x00,
  0x00, 0x6f, 0xe1, 0x78, 0x00, 0x30, 0x30, 0x0e, 0x00, 0x00, 0x4f, 0xbf, 0xc0, 0x00, 0x00, 0x38,
  0x41, 0x18, 0x00, 0x1f, 0xf0, 0x0e, 0x00, 0x00, 0x78, 0x90, 0x80, 0x00, 0x00, 0x18, 0x43, 0x30,
  0x00, 0x01, 0xe0, 0x0e, 0x00, 0x00, 0x30, 0x93, 0xc0, 0x00, 0x00, 0x0e, 0x43, 0xe0, 0x00, 0x01,
  0xe0, 0x0e, 0x00, 0x00, 0x1f, 0x8f, 0x80, 0x00, 0x00, 0x07, 0xc3, 0x00, 0x00, 0x01, 0xe0, 0x0e,
  0x00, 0x00, 0x07, 0x88, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x01, 0xc0, 0x06, 0x00, 0x00,
  0x00, 0x88, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x03, 0xc0, 0x02, 0x00, 0x00, 0x00, 0x88,
  0x00, 0x00, 0x00, 0x01, 0x81, 0x00, 0x00, 0x07, 0x80, 0x03, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00,
  0x00, 0x01, 0x01, 0x00, 0x00, 0x0e, 0x00, 0x03, 0x80, 0x00, 0x01, 0x84, 0x00, 0x00, 0x00, 0x01,
  0x81, 0x80, 0x00, 0x0f, 0x00, 0x01, 0x80, 0x00, 0x03, 0x06, 0x00, 0x00, 0x00, 0x03, 0x81, 0x80,
  0x00, 0x1c, 0x00, 0x01, 0xc3, 0xfe, 0x03, 0x06, 0x00, 0x00, 0x80, 0x07, 0x01, 0xc0, 0x7f, 0xf8,
  0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag06', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag06[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x0f, 0xc0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1f, 0xc0, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
  0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x80, 0x00,
  0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x1c, 0x06, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x1e, 0x06, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf0, 0x00, 0x3e, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x1e, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x3e, 0x00, 0x03, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x00,
  0x07, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x80, 0x06, 0x00,
  0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x40, 0x06, 0x00, 0x01, 0xc1,
  0xe3, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x30, 0x10, 0x60, 0x04, 0x00, 0x00, 0xf0, 0xc3, 0x00,
  0x1c, 0x78, 0x00, 0x00, 0x00, 0x20, 0x38, 0x10, 0x04, 0x00, 0x00, 0x60, 0x02, 0x00, 0x38, 0x1e,
  0x00, 0x00, 0x00, 0x60, 0x70, 0x08, 0x04, 0x00, 0x00, 0x00, 0x06, 0x00, 0x60, 0x03, 0x00, 0x00,
  0x00, 0x40, 0x00, 0x84, 0x04, 0x00, 0x00, 0x00, 0x06, 0x00, 0xc0, 0x81, 0x80, 0x00, 0x00, 0xc0,
  0x01, 0xc4, 0x06, 0x00, 0x1f, 0xfc, 0x0c, 0x00, 0x01, 0xc0, 0xc0, 0x00, 0x00, 0x60, 0x00, 0xc6,
  0x06, 0x00, 0x7f, 0xff, 0xbc, 0x01, 0x00, 0x00, 0x40, 0x00, 0x00, 0x42, 0x18, 0x02, 0x01, 0x81,
  0xf8, 0x0f, 0xfc, 0x00, 0x20, 0x0c, 0x60, 0x00, 0x00, 0x43, 0x18, 0x02, 0x01, 0x8f, 0xf0, 0x0c,
  0x1c, 0x00, 0x33, 0x0c, 0x20, 0x00, 0x00, 0x43, 0x00, 0x02, 0x00, 0xfe, 0x38, 0x1c, 0x38, 0x00,
  0x30, 0x00, 0x20, 0x00, 0x00, 0x60, 0x00, 0x06, 0x00, 0x70, 0x30, 0x1c, 0x60, 0x01, 0x00, 0x00,
  0x60, 0x00, 0x00, 0x20, 0xff, 0xc4, 0x00, 0x70, 0x10, 0x1c, 0xc0, 0x01, 0x80, 0x00, 0x40, 0x00,
  0x00, 0x37, 0xf1, 0x78, 0x00, 0x30, 0x30, 0x1f, 0x80, 0x00, 0x9d, 0xf1, 0xc0, 0x00, 0x00, 0x1c,
  0x21, 0x18, 0x00, 0x1f, 0xf0, 0x1c, 0x00, 0x00, 0xf1, 0xff, 0x80, 0x00, 0x00, 0x0c, 0x21, 0x30,
  0x00, 0x00, 0xe0, 0x1c, 0x00, 0x00, 0x61, 0x11, 0x00, 0x00, 0x00, 0x07, 0x21, 0xe0, 0x00, 0x00,
  0xe0, 0x1c, 0x00, 0x00, 0x3f, 0x1f, 0x00, 0x00, 0x00, 0x03, 0xe1, 0x80, 0x00, 0x00, 0xe0, 0x1c,
  0x00, 0x00, 0x0f, 0x10, 0x00, 0x00, 0x00, 0x00, 0x41, 0x00, 0x00, 0x00, 0xc0, 0x0c, 0x00, 0x00,
  0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x41, 0x00, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x00, 0x01, 0x10,
  0x00, 0x00, 0x00, 0x00, 0xc0, 0x80, 0x00, 0x03, 0x80, 0x06, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00,
  0x00, 0x01, 0x80, 0x80, 0x00, 0x07, 0x00, 0x02, 0x00, 0x00, 0x01, 0x84, 0x00, 0x00, 0x00, 0x01,
  0x80, 0xc0, 0x00, 0x07, 0x00, 0x01, 0x00, 0x00, 0x03, 0x06, 0x00, 0x00, 0xc0, 0x03, 0x00, 0xc0,
  0x00, 0x0e, 0x00, 0x01, 0x80, 0x00, 0x07, 0x06, 0x00, 0x00, 0xff, 0xff, 0x80, 0xc0, 0x3f, 0xfc,
  0x40, 0x03, 0xe7, 0xff, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
// 'Omri_Pilztag07', 108x47px
const unsigned char pilz_bitmap_Omri_Pilztag07[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x0f, 0xe0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x0f, 0xc0, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
  0x80, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x00,
  0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x18, 0x18, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x1c, 0x0c, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x00, 0x3e, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x1c, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x1f, 0x00, 0x03, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc0,
  0x07, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x60, 0x02, 0x00,
  0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x20, 0x02, 0x00, 0x01, 0xc1,
  0xe3, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x18, 0x08, 0x30, 0x02, 0x00, 0x00, 0xe1, 0xc3, 0x00,
  0x1c, 0x38, 0x00, 0x00, 0x00, 0x10, 0x1c, 0x18, 0x02, 0x00, 0x00, 0x40, 0x82, 0x00, 0x38, 0x1e,
  0x00, 0x00, 0x00, 0x30, 0x38, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x60, 0x83, 0x00, 0x00,
  0x00, 0x20, 0x00, 0x44, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0xc0, 0xc1, 0x80, 0x00, 0x00, 0x60,
  0x00, 0xc4, 0x03, 0x00, 0x1f, 0xf8, 0x18, 0x00, 0x00, 0xc0, 0xc0, 0x00, 0x00, 0x60, 0x00, 0x46,
  0x03, 0x00, 0x7f, 0xff, 0xf8, 0x01, 0x00, 0x00, 0x40, 0x00, 0x00, 0x43, 0x0c, 0x02, 0x01, 0x81,
  0xf8, 0x1f, 0xf8, 0x00, 0x22, 0x0c, 0x60, 0x00, 0x00, 0x43, 0x0c, 0x02, 0x01, 0x8f, 0xf0, 0x0c,
  0x38, 0x00, 0x31, 0x8c, 0x20, 0x00, 0x00, 0x43, 0x00, 0x02, 0x00, 0xfe, 0x18, 0x1c, 0x20, 0x02,
  0x30, 0x00, 0x20, 0x00, 0x00, 0x60, 0x00, 0x06, 0x00, 0x78, 0x10, 0x1c, 0x60, 0x01, 0x00, 0x00,
  0x60, 0x00, 0x00, 0x21, 0xff, 0xc4, 0x00, 0x38, 0x10, 0x1c, 0xc0, 0x01, 0x81, 0xc0, 0x40, 0x00,
  0x00, 0x2f, 0xe1, 0x78, 0x00, 0x18, 0x30, 0x1f, 0x80, 0x00, 0x9f, 0xb8, 0xe0, 0x00, 0x00, 0x38,
  0x41, 0x18, 0x00, 0x0f, 0xf0, 0x1c, 0x00, 0x00, 0xf1, 0x10, 0x80, 0x00, 0x00, 0x18, 0x43, 0x30,
  0x00, 0x00, 0xe0, 0x1c, 0x00, 0x00, 0x61, 0x13, 0x80, 0x00, 0x00, 0x0e, 0x43, 0xe0, 0x00, 0x00,
  0xe0, 0x1c, 0x00, 0x00, 0x3f, 0x1f, 0x00, 0x00, 0x00, 0x07, 0xc3, 0x00, 0x00, 0x00, 0xc0, 0x1c,
  0x00, 0x00, 0x0f, 0x10, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x01, 0xe0, 0x0c, 0x00, 0x00,
  0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x03, 0xc0, 0x0c, 0x00, 0x00, 0x00, 0x88,
  0x00, 0x00, 0x00, 0x01, 0x81, 0x00, 0x00, 0x07, 0x80, 0x06, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00,
  0x00, 0x01, 0x01, 0x00, 0x00, 0x07, 0x80, 0x02, 0x00, 0x00, 0x01, 0x84, 0x00, 0x00, 0x00, 0x03,
  0x01, 0x80, 0x00, 0x0f, 0x00, 0x01, 0x00, 0x00, 0x03, 0x06, 0x00, 0x00, 0x00, 0x07, 0x01, 0x80,
  0x00, 0x0e, 0x00, 0x01, 0x80, 0x00, 0x07, 0x07, 0x00, 0x00, 0x00, 0x0e, 0x01, 0xc0, 0x3f, 0xff,
  0xe0, 0x03, 0xc7, 0xff, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 11008)
const int pilz_bitmap_allArray_LEN = 8;
const unsigned char* pilz_bitmap_allArray[8] = {
  pilz_bitmap_Omri_Pilztag00,
  pilz_bitmap_Omri_Pilztag01,
  pilz_bitmap_Omri_Pilztag02,
  pilz_bitmap_Omri_Pilztag03,
  pilz_bitmap_Omri_Pilztag04,
  pilz_bitmap_Omri_Pilztag05,
  pilz_bitmap_Omri_Pilztag06,
  pilz_bitmap_Omri_Pilztag07,

};

uint8_t currentFrame = 0;



void drawMushroomBitmap() {
  hw.display.drawBitmap((SCREEN_WIDTH - 108) / 2, 5, pilz_bitmap_allArray[currentFrame], 108, 47, WHITE);
}


void setup() {
#ifdef ROTATE_PANEL
  hw.config.RotatePanel = true;
#endif

#ifdef REVERSE_ENCODER
  hw.config.ReverseEncoder = true;
#endif

  hw.Init();
  randomizeGrid(true);
  lastEEPROMWrite = millis();
  loadGridFromEEPROM();
}


void loadGridFromPROGMEM() {
  for (uint8_t y = 0; y < gridHeight; y++) {
    uint8_t packedRow = pgm_read_byte(&initialGridBits[y]);
    for (uint8_t x = 0; x < gridWidth; x++) {
      tempGrid[x][y] = (packedRow >> (6 - x)) & 0x01;
    }
  }
}

void resetToInitialState() {
  // Read the initial state from PROGMEM and unpack it into the grid
  for (uint8_t y = 0; y < gridHeight; y++) {
    uint8_t packedRow = pgm_read_byte(&initialGridBits[y]);  // Read a packed row from PROGMEM
    for (uint8_t x = 0; x < gridWidth; x++) {
      grid[x][y] = (packedRow >> (6 - x)) & 0x01;  // Unpack each bit to fill the grid
    }
  }
}


void saveInitialState() {
  isInitialState = true;
}


void createNewInitialState() {
  randomizeGrid(true);
  isInitialState = true;
  resetCounter = 0;
}

void randomizeGrid(bool centerSpawn) {
  memset(grid, 0, sizeof(grid));

  if (centerSpawn) {
    uint8_t centerX = gridWidth / 2;
    uint8_t centerY = gridHeight / 2;

    // Spawn near the center
    for (uint8_t i = 0; i < MIN_CELLS; i++) {
      uint8_t x = centerX + random(-2, 3);  // Spawn within Â±2 of center
      uint8_t y = centerY + random(-2, 3);
      if (x < gridWidth && y < gridHeight) {
        grid[x][y] = 1;
      }
    }
  } else {
    // Random spawn throughout the grid
    for (uint8_t x = 0; x < gridWidth; x++) {
      for (uint8_t y = 0; y < gridHeight; y++) {
        if (random(0, 10) < 3) {
          grid[x][y] = 1;
        }
      }
    }
  }
}

void loadGridFromEEPROM() {
  for (uint8_t y = 0; y < gridHeight; y++) {
    uint8_t packedRow = EEPROM.read(y);
    for (uint8_t x = 0; x < gridWidth; x++) {
      grid[x][y] = (packedRow >> (6 - x)) & 0x01;
    }
  }
}

void saveGridToEEPROM() {
  for (uint8_t y = 0; y < gridHeight; y++) {
    uint8_t packedRow = 0;
    for (uint8_t x = 0; x < gridWidth; x++) {
      packedRow |= (grid[x][y] << (6 - x));
    }
    EEPROM.write(y, packedRow);
  }
}

void injectCentricCellBirth(uint8_t liveCellCount) {
  if (liveCellCount < maxCells) {
    uint8_t cellsToInject = map(liveCellCount, 0, maxCells, 6, 1);  // Inject more cells if population is low
    for (uint8_t i = 0; i < cellsToInject; i++) {
      uint8_t x = gridWidth / 2 + random(-gridWidth / 8, gridWidth / 8);
      uint8_t y = gridHeight / 2 + random(-gridHeight / 8, gridHeight / 8);
      grid[x][y] = 1;
    }
  }
}

inline uint8_t countNeighbors(uint8_t x, uint8_t y) {
  uint8_t count = 0;
  for (uint8_t i = 0; i < 8; i++) {
    int8_t nx = x + (int8_t)pgm_read_byte(&neighborOffsets[i][0]);
    int8_t ny = y + (int8_t)pgm_read_byte(&neighborOffsets[i][1]);
    if (nx >= 0 && nx < gridWidth && ny >= 0 && ny < gridHeight) {
      count += grid[nx][ny];
    }
  }
  return count;
}

void updateSimulation() {
  uint8_t newGrid[gridWidth][gridHeight] = {};
  uint8_t liveCellCount = 0;
  uint8_t stableCells = 0;
  uint8_t birthCount = 0;
  uint8_t deathCount = 0;

  for (uint8_t x = 0; x < gridWidth; x++) {
    for (uint8_t y = 0; y < gridHeight; y++) {
      bool cellState = grid[x][y];
      uint8_t neighbors = countNeighbors(x, y);

      if (cellState && (neighbors < 2 || neighbors > 3)) {
        // Cell dies
        deathCount++;
      } else if (!cellState && neighbors == 3) {
        // Cell is born
        newGrid[x][y] = 1;
        birthCount++;
        liveCellCount++;
      } else if (cellState) {
        // Cell survives
        newGrid[x][y] = 1;
        liveCellCount++;
        if (neighbors == 2 || neighbors == 3) {
          stableCells++;
        }
      }
    }
  }

  // Update the grid state
  memcpy(grid, newGrid, sizeof(grid));

  // Determine when to trigger based on aggregate birth and death counts
  const uint8_t birthThreshold = 9;  // Adjust this threshold as necessary
  const uint8_t deathThreshold = 7;  // Adjust this threshold as necessary

  if (birthCount >= birthThreshold) {
    hw.outputs[1].High();  // Trigger on significant cell birth events
  }

  if (deathCount >= deathThreshold) {
    hw.outputs[0].High();  // Trigger on significant cell death events
  }

  // Trigger outputs based on population dynamics
  if (stableCells > (gridWidth * gridHeight) / 2) {
    hw.outputs[2].High();  // Trigger on high stability
  }
  if (birthCount > deathCount && liveCellCount < maxCells) {
    hw.outputs[3].High();  // Trigger on population growth
  }
  if (deathCount > birthCount) {
    hw.outputs[4].High();  // Trigger on population decline
  }
  if (liveCellCount > maxCells / 2 || liveCellCount > maxCells) {
    hw.outputs[5].High();  // Trigger on overpopulation
  }

  currentFrame = (currentFrame + 1) % pilz_bitmap_allArray_LEN;

  // Dynamic spawning based on live cells
  static uint8_t updateCounter = 0;
  updateCounter++;

  if (liveCellCount < MIN_CELLS && updateCounter >= SPAWN_INTERVAL) {
    updateCounter = 0;
    uint8_t spawnChance = map(liveCellCount, 0, MIN_CELLS, 100, 10);  // Higher chance of spawning when few cells
    if (random(100) < spawnChance) {
      uint8_t x = random(0, gridWidth);
      uint8_t y = random(0, gridHeight);
      if (grid[x][y] == 0) {
        grid[x][y] = 1;
        liveCellCount++;
      }
    }
  }

  // Reset update counter if population is healthy
  if (liveCellCount >= MIN_CELLS) {
    updateCounter = 0;
  }

  centricSpawnCounter++;
  if (centricSpawnCounter > (useExternalClock ? 10 : 5)) {
    injectCentricCellBirth(liveCellCount);
    centricSpawnCounter = 0;
  }
}

void drawSimulation() {
  hw.display.clearDisplay();
  drawMushroomBitmap();
  hw.display.drawLine(0, SCREEN_HEIGHT - 14, SCREEN_WIDTH, SCREEN_HEIGHT - 14, WHITE);

  for (uint8_t x = 0; x < gridWidth; x++) {
    for (uint8_t y = 0; y < gridHeight; y++) {
      if (grid[x][y]) {
        hw.display.drawRect(x * 3, y * 2 + (SCREEN_HEIGHT - 14), 3, 3, WHITE);
      }
    }
  }

  hw.display.display();
}

void loop() {
  hw.ProcessInputs();

  unsigned long currentTime = millis();

    // External clock timeout handling
    if (useExternalClock && (currentTime - lastClockTime > CLOCK_TIMEOUT)) {
        useExternalClock = false;
    }

    // Save to EEPROM every 5 minutes
    if (currentTime - lastEEPROMWrite > EEPROM_WRITE_INTERVAL) {
        saveGridToEEPROM();
        lastEEPROMWrite = currentTime;
    }

    // Animation update
    drawMushroomBitmap();
    currentFrame = (currentFrame + 1) % 8;

  // Handle encoder rotation
  Encoder::Direction dir = hw.encoder.rotate();
  if (dir == Encoder::DIRECTION_INCREMENT) {
    if (selectedParameter == 0) attraction = min(attraction + 1, 10);
    else if (selectedParameter == 1) repulsion = min(repulsion + 1, 10);
    else if (selectedParameter == 2) randomness = min(randomness + 1, 10);
  } else if (dir == Encoder::DIRECTION_DECREMENT) {
    if (selectedParameter == 0) attraction = max(attraction - 1, 0);
    else if (selectedParameter == 1) repulsion = max(repulsion - 1, 0);
    else if (selectedParameter == 2) randomness = max(randomness - 1, 0);
  }

  // Handle encoder press and external reset
  Encoder::PressType press = hw.encoder.Pressed();
  if (press == Encoder::PRESS_LONG || hw.rst.State() == DigitalInput::STATE_RISING) {
    if (isInitialState) {
      resetCounter++;
      if (resetCounter >= RESET_THRESHOLD) {
        createNewInitialState();  // Create a new initial state
      }
    } else {
      resetToInitialState();  // Return to the initial state
    }
  }


  // Check for external clock
  if (hw.clk.State() == DigitalInput::STATE_RISING) {
    lastExternalClockTime = currentTime;
    useExternalClock = true;
    updateSimulation();
    drawSimulation();
  } else {
    // Check if we need to switch to internal clock
    if (useExternalClock && (currentTime - lastExternalClockTime >= CLOCK_TIMEOUT)) {
      useExternalClock = false;
    }

    // Use internal clock if no external clock is detected
    if (!useExternalClock) {
      static unsigned long lastInternalUpdateTime = 0;
      if (currentTime - lastInternalUpdateTime >= INTERNAL_CLOCK_INTERVAL) {
        lastInternalUpdateTime = currentTime;
        updateSimulation();
        drawSimulation();
      }
    }
  }

  // Ensure outputs are low after events
  for (uint8_t i = 0; i < OUTPUT_COUNT; i++) {
    hw.outputs[i].Low();
  }
}
